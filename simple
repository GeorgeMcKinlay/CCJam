local function require(file)
	return dofile(shell.resolve(file))
end

local SIMPLE_SCRIPT_DIR = shell.resolve("simplescript")
local Lexer = require("simplescript/lexer.lua")
local Interpreter = require("simplescript/interpreter.lua")

local localLexer = Lexer.new()
local localInterpreter = Interpreter.new()

local function runString(str, clearLexer)
	if clearLexer == nil then clearLexer = false end
	if clearLexer then localLexer:clear() end
	local err = localLexer:tokenise(str)
	if err ~= nil then printError(err) end
	--[[local file = fs.open("parseTree.txt", "w")
	file.write(textutils.serialise(localLexer.parseTree))
	file.close()]]
	localInterpreter:interpret(localLexer.parseTree, true)
end

local function runFile(file)
	local f = fs.open(file, "r")
	if f == nil then error("File not found", 0) end
	local str = f.readAll()
	runString(str)
	f.close()
end

localInterpreter:loadPackage(shell.resolve("simplescript/pkgs/computer", "Dimitri"))
localInterpreter:loadPackage(shell.resolve("simplescript/pkgs/terminal"))

if turtle then
	localInterpreter:loadPackage(shell.resolve("simplescript/pkgs/turtle"))
end

local argv = { ... }
local argc = #argv

if argc ~= 0 then
	local file = argv[1]
	runFile(shell.resolve(file))
	return
end

if not fs.exists(SIMPLE_SCRIPT_DIR) or not fs.isDir(SIMPLE_SCRIPT_DIR) then
	printError("Couldn't find the simplescript core files!")
	return
end

local history = {}
local termColour = term.isColour() and colours.cyan or colours.white

term.setTextColour(termColour)
print("SimpleScript v1.0 Console")

while true do
	term.setTextColour(termColour)
	write("> ")
	
	term.setTextColour(colours.white)
	local input = read(nil, history)
	if input:lower() == "exit" then break end
	if input:lower() == "clear" then localLexer:clear() end
	table.insert(history, input)
	runString(input, true)
end